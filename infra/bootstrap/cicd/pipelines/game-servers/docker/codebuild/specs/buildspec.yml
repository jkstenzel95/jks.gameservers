version: 0.2

phases:
  install:
    commands:
      - sudo yum install -y yum-utils jq
      - sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
      - sudo yum install docker-ce docker-ce-cli containerd.io
  pre_build:
    commands:
      - aws eks --region us-east-2 update-kubeconfig --name jks-use2
      - aws secretsmanager get-secret-value --secret-id jks/DockerPassword --query SecretString --output text | jq '."DockerPassword"' sudo docker login | sudo docker login --username jkstenzel95 --password-stdin
      - version=$(printf '%(%Y%m%d%k%M)T\n' -1)
  build:
    commands:
      - docker build Dockerfile.Init -t "jkstenzel95/jks_gameserver_init:${env}.latest" -t "jkstenzel95/jks_gameserver_init:${env}.$version"
      - docker build Dockerfile.Runtime -t "jkstenzel95/jks_gameserver_runtime:${env}.latest" -t "jkstenzel95/jks_gameserver_runtime:${env}.$version"
      - docker push -a "jkstenzel95/jks_gameserver_init"
      - docker push -a "jkstenzel95/jks_gameserver_runtime"